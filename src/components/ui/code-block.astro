---
import { Code } from 'astro:components';
import type { ComponentProps } from 'astro/types';
import { cn } from '@/lib/utils';
import Button from './button.astro';

type Props = ComponentProps<typeof Code> & {
  title?: string;
  class?: string;
  size?: '2xl' | 'xl' | 'lg' | 'md' | 'sm' | 'xs' | 'snippet' | 'tiny';
};
const sizeMap = {
  '2xl': 'h-[24rem] sm:h-[32rem] md:h-[40rem] lg:h-[48rem]',
  xl: 'h-[20rem] sm:h-[28rem] md:h-[34rem] lg:h-[40rem]',
  lg: 'h-[16rem] sm:h-[24rem] md:h-[28rem] lg:h-[32rem]',
  md: 'h-64 sm:h-80 md:h-96',
  sm: 'h-48 sm:h-56 md:h-64',
  xs: 'h-32 sm:h-40 md:h-48',
  snippet: 'h-24 sm:h-28 md:h-32',
  tiny: 'h-16 sm:h-20 md:h-24',
};

const { title, size, class: className, ...props } = Astro.props;
---

<div
  class={cn(
    'relative rounded-lg border border-border',
    'bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/75',
    className
  )}
>

  <div
    class="sticky top-0 z-10 flex items-center px-4 py-2 bg-muted/50 border-b border-border"
  >
 
    <div class="flex items-center space-x-2">
      <div class="w-3 h-3 rounded-full bg-red-500"></div>
      <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
      <div class="w-3 h-3 rounded-full bg-green-500"></div>
    </div>


    {
      title && (
        <span class="ml-4 text-sm text-muted-foreground font-medium">
          {title}
        </span>
      )
    }


    <Button
      variant="ghost"
      size="sm"
      rounded="md"
      class="ml-auto"
      data-copy-button
      data-code={props.code}
      aria-label="Copy code"
    >
      <span class="sr-only">Copy</span>
      <svg
        data-copy-icon
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path
          d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
      </svg>
      <svg
        data-check-icon
        class="hidden"
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </Button>
  </div>

  <Code
    {...props}
    class={cn(
      'overflow-x-auto overflow-y-auto font-mono text-sm',
      (size && sizeMap[size]) || 'h-96',
      'p-0 xs:p-1 sm:p-1.5 md:p-2 lg:p-2.5 xl:p-3 2xl:p-4'
    )}
  />
</div>

<script>
  class CodeBlock {
    private element: HTMLElement;
    private copyButton: HTMLButtonElement | null;
    private copyIcon: SVGElement | null;
    private checkIcon: SVGElement | null;
    private code: string;

    constructor(element: HTMLElement) {
      this.element = element;
      this.copyButton = element.querySelector('[data-copy-button]');
      this.copyIcon = element.querySelector('[data-copy-icon]');
      this.checkIcon = element.querySelector('[data-check-icon]');

      this.code = this.copyButton?.getAttribute('data-code') || '';

      this.init();
    }

    private init() {
      if (!this.copyButton) return;

      this.copyButton.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(this.code);
          this.showCopySuccess();
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    }

    private showCopySuccess() {
      if (!this.copyIcon || !this.checkIcon || !this.copyButton) return;

      this.copyIcon.classList.add('hidden');
      this.checkIcon.classList.remove('hidden');
      this.copyButton.classList.add('text-green-500');

      setTimeout(() => {
        this.copyIcon?.classList.remove('hidden');
        this.checkIcon?.classList.add('hidden');
        this.copyButton?.classList.remove('text-green-500');
      }, 2000);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-copy-button]').forEach((element) => {
      new CodeBlock(element.closest('div') as HTMLElement);
    });
  });
</script>

<style>
  :global(.astro-code) {
    scrollbar-width: thin;
    scrollbar-color: var(--muted-foreground-30) var(--muted);
  }

  :global(.astro-code:hover) {
    scrollbar-color: var(--muted-) var(--muted);
  }
</style>
